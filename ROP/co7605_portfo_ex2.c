// CO7605 Software Exploitation (AY 2022-23)
//    Assessment Component 2 (Portfolio)
//      - Exercise 2: Stack Overflow and Direct Code Execution
// Main File
#include "co7605_portfo_ex2.h"

#define MAX_DATA_SIZE  256


void serve_welcome_response(int the_connection)
{
    char buffer[32];          // buffer to hold the client's name

    memset(buffer, 0, 32);    // Clear the buffer for receiving

    // Send the query to the client...
    write(the_connection, "Please enter your name: ", 24);

    // Get the client's name...
    read(the_connection, buffer, MAX_DATA_SIZE);

    // Print the received message locally...
    printf("Message received: ");
    printf(buffer);
    printf("\n");

    // Send the message back to the client to welcome them...
    write(the_connection, "Welcome ", 8);      // Send 8 characters 
    write(the_connection, buffer, strlen(buffer));

    return;
}


int server_loop(int port_number)
{
    int  sockfd, newsockfd;
    char some_space[48];

    // Establish a socket for this server to listen on...
    sockfd = create_socket(port_number);

    for (;;) {   // Loop forever

        // Accept a new connection - get a 'new socket fd' to handle it...
        newsockfd = accept_connection(sockfd);

        // serve the client...
        serve_welcome_response(newsockfd);

        // We've now finished with this 'new socket file descriptor'
        close(newsockfd);
    }
}


int main(int argc, char *argv[])
{
    char some_space[64];
    int port_number;

    if (argc < 2) {
        printf("ERROR: no port provided\n");
        exit(-1);
    }
    else
    {
        // Get the port number as provided on the command line...
        port_number = atoi(argv[1]);

        server_loop(port_number);
    }
}
